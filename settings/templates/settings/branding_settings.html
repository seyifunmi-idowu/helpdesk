{% extends 'base.html' %}

{% block title %}Branding Settings{% endblock %}

{% block content %}
    <section class="content-header">
        <div class="container-fluid">
            <div class="row mb-2">
                <div class="col-sm-6">
                    <h1>Branding & Appearance</h1>
                </div>
                <div class="col-sm-6">
                    <ol class="breadcrumb float-sm-right">
                        <li class="breadcrumb-item"><a href="{% url 'dashboard' %}">Home</a></li>
                        <li class="breadcrumb-item active">Branding Settings</li>
                    </ol>
                </div>
            </div>
        </div>
    </section>

    <section class="content">
        <div class="container-fluid">
            <div class="card">
                <div class="card-header">
                    <h4 class="card-title">Branding & Appearance</h4>
                </div>
                <div class="card-body">
                    {% if messages %}
                        {% for message in messages %}
                            <div class="alert alert-{{ message.tags }}">{{ message }}</div>
                        {% endfor %}
                    {% endif %}
                    <form method="post" enctype="multipart/form-data">
                        {% csrf_token %}
                        <ul class="nav nav-tabs" id="myTab" role="tablist">
                            <li class="nav-item">
                                <a class="nav-link active" id="general-tab" data-toggle="tab" href="#general" role="tab" aria-controls="general" aria-selected="true">General</a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" id="time-tab" data-toggle="tab" href="#time" role="tab" aria-controls="time" aria-selected="false">Time</a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" id="seo-tab" data-toggle="tab" href="#seo" role="tab" aria-controls="seo" aria-selected="false">SEO</a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" id="links-tab" data-toggle="tab" href="#links" role="tab" aria-controls="links" aria-selected="false">Links</a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" id="advanced-tab" data-toggle="tab" href="#advanced" role="tab" aria-controls="advanced" aria-selected="false">Advanced</a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" id="broadcast-tab" data-toggle="tab" href="#broadcast" role="tab" aria-controls="broadcast" aria-selected="false">Broadcast Message</a>
                            </li>
                        </ul>
                        <div class="tab-content" id="myTabContent">
                            <div class="tab-pane fade show active" id="general" role="tabpanel" aria-labelledby="general-tab">
                                <h5>General Settings</h5>
                                <!-- General Tab Content Here -->
                                <div class="form-group">
                                    <label for="id_name">Name</label>
                                    <input type="text" class="form-control" id="id_name" name="name" value="{{ website.name }}">
                                </div>
                                <div class="form-group">
                                    <label for="id_site_description">Tag Line</label>
                                    <input type="text" class="form-control" id="id_site_description" name="site_description" value="{{ knowledgebase.site_description|default_if_none:'' }}">
                                    <small class="form-text text-muted">Hi! how can i help you.</small>
                                </div>
                                <div class="form-group">
                                    <label for="id_logo">Wide Logo</label>
                                    <input type="file" class="form-control-file" id="id_logo" name="logo">
                                    {% if website.logo %}
                                        <img src="{{ website.logo.url }}" alt="Logo" class="img-thumbnail mt-2" style="max-width: 200px;">
                                    {% endif %}
                                    <small class="form-text text-muted">Upload an Image (200px x 48px) in PNG or JPG Format</small>
                                </div>
                                <div class="form-group form-check">
                                    <input type="checkbox" class="form-check-input" id="id_is_active" name="is_active" {% if website.is_active %}checked{% endif %}>
                                    <label class="form-check-label" for="id_is_active">Website Status (Enable front end website and knowledgebase for customer(s))</label>
                                </div>
                            </div>
                            <div class="tab-pane fade" id="time" role="tabpanel" aria-labelledby="time-tab">
                                <h5>Time Settings</h5>
                                <!-- Time Tab Content Here -->
                                <div class="form-group">
                                    <label for="id_timezone">Timezone</label>
                                    <select class="form-control" id="id_timezone" name="timezone">
                                        {% for tz in timezones %}
                                            <option value="{{ tz }}" {% if website.timezone == tz %}selected{% endif %}>{{ tz }}</option>
                                        {% endfor %}
                                    </select>
                                    <small class="form-text text-muted">Choose a default company's timezone</small>
                                </div>
                                <div class="form-group">
                                    <label for="id_timeformat">Date Time Format</label>
                                    <select class="form-control" id="id_timeformat" name="timeformat">
                                        <option value="m-d-y G:i" {% if website.timeformat == 'm-d-y G:i' %}selected{% endif %}>m-d-y G:i (01-15-1991 13:00)</option>
                                        <!-- Add more time format options as needed -->
                                    </select>
                                    <small class="form-text text-muted">Choose a format to convert date to specified date time format</small>
                                </div>
                            </div>
                            <div class="tab-pane fade" id="seo" role="tabpanel" aria-labelledby="seo-tab">
                                <h5>SEO Settings</h5>
                                <!-- SEO Tab Content Here -->
                                <div class="form-group">
                                    <label for="id_meta_description">Meta Description (Recommended)</label>
                                    <textarea class="form-control" id="id_meta_description" name="meta_description" rows="3">{{ knowledgebase.meta_description|default_if_none:'' }}</textarea>
                                </div>
                                <div class="form-group">
                                    <label for="id_meta_keywords">Meta Keywords (Recommended)</label>
                                    <textarea class="form-control" id="id_meta_keywords" name="meta_keywords" rows="3">{{ knowledgebase.meta_keywords|default_if_none:'' }}</textarea>
                                </div>
                            </div>
                            <div class="tab-pane fade" id="links" role="tabpanel" aria-labelledby="links-tab">
                                <h5>Links Settings</h5>
                                <!-- Links Tab Content Here -->
                                <div class="form-group">
                                    <label>Header Links</label>
                                    <div id="header-links-container">
                                        <!-- Existing header links will be rendered here by JS or loop -->
                                        <div class="input-group mb-2">
                                            <input type="text" class="form-control" placeholder="Title" name="header_link_title[]">
                                            <input type="text" class="form-control" placeholder="URL" name="header_link_url[]">
                                            <div class="input-group-append">
                                                <button class="btn btn-outline-secondary add-link" type="button" data-target="header-links-container">+</button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label>Footer Links</label>
                                    <div id="footer-links-container">
                                        <!-- Existing footer links will be rendered here by JS or loop -->
                                        <div class="input-group mb-2">
                                            <input type="text" class="form-control" placeholder="Title" name="footer_link_title[]">
                                            <input type="text" class="form-control" placeholder="URL" name="footer_link_url[]">
                                            <div class="input-group-append">
                                                <button class="btn btn-outline-secondary add-link" type="button" data-target="footer-links-container">+</button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="tab-pane fade" id="advanced" role="tabpanel" aria-labelledby="advanced-tab">
                                <h5>Advanced Settings</h5>
                                <!-- Advanced Tab Content Here -->
                                <div class="form-group">
                                    <label for="id_custom_css">Custom CSS (Optional)</label>
                                    <textarea class="form-control" id="id_custom_css" name="custom_css" rows="10">{{ knowledgebase.custom_css|default_if_none:'' }}</textarea>
                                    <small class="form-text text-muted">Displayed only in front end knowledge base</small>
                                </div>
                                <div class="form-group">
                                    <label for="id_script">Custom Javascript (Optional)</label>
                                    <textarea class="form-control" id="id_script" name="script" rows="10">{{ knowledgebase.script|default_if_none:'' }}</textarea>
                                    <small class="form-text text-muted">Displayed only in front end knowledge base</small>
                                </div>
                            </div>
                            <div class="tab-pane fade" id="broadcast" role="tabpanel" aria-labelledby="broadcast-tab">
                                <h5>Broadcast Message Settings</h5>
                                <!-- Broadcast Tab Content Here -->
                                <div class="form-group">
                                    <label for="id_broadcast_message">Broadcast Message</label>
                                    <textarea class="form-control" id="id_broadcast_message" name="broadcast_message" rows="5">{{ knowledgebase.broadcast_message|default_if_none:'' }}</textarea>
                                    <small class="form-text text-muted">Broadcast message content to show on helpdesk</small>
                                </div>
                                <div class="form-group">
                                    <label for="id_broadcast_from_date">From date</label>
                                    <input type="datetime-local" class="form-control" id="id_broadcast_from_date" name="broadcast_from_date" value="{{ knowledgebase.broadcast_from_date|date:'Y-m-d\TH:i' }}">
                                </div>
                                <div class="form-group">
                                    <label for="id_broadcast_to_date">To date</label>
                                    <input type="datetime-local" class="form-control" id="id_broadcast_to_date" name="broadcast_to_date" value="{{ knowledgebase.broadcast_to_date|date:'Y-m-d\TH:i' }}">
                                    <small class="form-text text-muted">How long should the message be displayed?</small>
                                </div>
                                <div class="form-group form-check">
                                    <input type="checkbox" class="form-check-input" id="id_broadcast_status" name="broadcast_status" {% if knowledgebase.broadcast_status %}checked{% endif %}>
                                    <label class="form-check-label" for="id_broadcast_status">Broadcasting Status (Broadcasting is Active)</label>
                                </div>
                            </div>
                        </div>
                        <button type="submit" class="btn btn-primary mt-3">Save Settings</button>
                    </form>
                </div>
            </div>
        </div>
    </section>
{% endblock %}

{% block extra_js %}
<script>
    // JavaScript for adding/removing dynamic link fields
    document.addEventListener('DOMContentLoaded', function() {
        document.querySelectorAll('.add-link').forEach(button => {
            button.addEventListener('click', function() {
                const targetId = this.dataset.target;
                const container = document.getElementById(targetId);
                const newLinkField = document.createElement('div');
                newLinkField.classList.add('input-group', 'mb-2');
                newLinkField.innerHTML = `
                    <input type="text" class="form-control" placeholder="Title" name="${targetId.includes('header') ? 'header_link_title[]' : 'footer_link_title[]'}">
                    <input type="text" class="form-control" placeholder="URL" name="${targetId.includes('header') ? 'header_link_url[]' : 'footer_link_url[]'}">
                    <div class="input-group-append">
                        <button class="btn btn-outline-danger remove-link" type="button">-</button>
                    </div>
                `;
                container.appendChild(newLinkField);
            });
        });

        document.addEventListener('click', function(event) {
            if (event.target.classList.contains('remove-link')) {
                event.target.closest('.input-group').remove();
            }
        });

        // Populate existing header and footer links
        const existingHeaderLinks = {{ knowledgebase.header_links|safe }};
        const existingFooterLinks = {{ knowledgebase.footer_links|safe }};

        function populateLinks(links, containerId, isHeader) {
            const container = document.getElementById(containerId);
            if (links) {
                links.forEach(link => {
                    const newLinkField = document.createElement('div');
                    newLinkField.classList.add('input-group', 'mb-2');
                    newLinkField.innerHTML = `
                        <input type="text" class="form-control" placeholder="Title" name="${isHeader ? 'header_link_title[]' : 'footer_link_title[]'}" value="${link.title || ''}">
                        <input type="text" class="form-control" placeholder="URL" name="${isHeader ? 'header_link_url[]' : 'footer_link_url[]'}" value="${link.url || ''}">
                        <div class="input-group-append">
                            <button class="btn btn-outline-danger remove-link" type="button">-</button>
                        </div>
                    `;
                    container.appendChild(newLinkField);
                });
            }
        }

        populateLinks(existingHeaderLinks, 'header-links-container', true);
        populateLinks(existingFooterLinks, 'footer-links-container', false);

        // Set initial values for datetime-local inputs
        const broadcastFromDate = document.getElementById('id_broadcast_from_date');
        const broadcastToDate = document.getElementById('id_broadcast_to_date');

        {% if knowledgebase.broadcast_from_date %}
            broadcastFromDate.value = "{{ knowledgebase.broadcast_from_date|date:'Y-m-d\TH:i' }}";
        {% endif %}
        {% if knowledgebase.broadcast_to_date %}
            broadcastToDate.value = "{{ knowledgebase.broadcast_to_date|date:'Y-m-d\TH:i' }}";
        {% endif %}

        // Set initial value for broadcast_status checkbox
        const broadcastStatusCheckbox = document.getElementById('id_broadcast_status');
        {% if knowledgebase.broadcast_status %}
            broadcastStatusCheckbox.checked = true;
        {% else %}
            broadcastStatusCheckbox.checked = false;
        {% endif %}

    });
</script>
{% endblock %}
