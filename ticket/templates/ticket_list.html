{% extends 'base.html' %}
{% load static %}

{% block title %}Tickets{% endblock %}

{% block content %}
    <!-- Content Header (Page header) -->
    <section class="content-header">
      <div class="container-fluid">
        <div class="row mb-2">
          <div class="col-sm-6">
            <h1>Tickets</h1>
          </div>
          <div class="col-sm-6">
            <ol class="breadcrumb float-sm-right">
              <li class="breadcrumb-item"><a href="{% url 'dashboard' %}">Home</a></li>
              <li class="breadcrumb-item active">Tickets</li>
            </ol>
          </div>
        </div>
      </div><!-- /.container-fluid -->
    </section>

    <!-- Main content -->
    <section class="content">
      <div class="container-fluid">
        <div class="row">
            <!-- Sidebar Filters -->
            <div class="col-md-3">
                <div class="card">
                    <div class="card-header">Filters</div>
                    <ul class="list-group list-group-flush">
                        {% for key, filter_data in sidebar_filters.items %}
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            <a href="#" class="sidebar-filter" data-filter-type="{{ key }}">{{ filter_data.label }}</a>
                            <span class="badge bg-primary rounded-pill">{{ filter_data.count }}</span>
                        </li>
                        {% endfor %}
                    </ul>
                </div>

                <!-- Sub-filters (Ticket Status) - Initially hidden -->
                <div class="card mt-3" id="status-subfilters" style="display: none;">
                    <div class="card-header">Status</div>
                    <ul class="list-group list-group-flush">
                        {% for code, status_data in status_counts.items %}
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            <a href="#" class="status-subfilter" data-status-code="{{ code }}">{{ status_data.label }}</a>
                            <span class="badge bg-secondary rounded-pill">{{ status_data.count }}</span>
                        </li>
                        {% endfor %}
                    </ul>
                </div>

                <!-- Sub-filters (Ticket Labels) - Initially hidden -->
                <div class="card mt-3" id="label-subfilters" style="display: none;">
                    <div class="card-header">Labels</div>
                    <ul class="list-group list-group-flush">
                        {% for id, label_data in label_counts.items %}
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            <a href="#" class="label-subfilter" data-label-id="{{ id }}">{{ label_data.label }}</a>
                            <span class="badge bg-info rounded-pill">{{ label_data.count }}</span>
                        </li>
                        {% endfor %}
                    </ul>
                </div>
            </div>

            <!-- Main Content Area - Ticket List -->
            <div class="col-md-9">
                {% if customer %}
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <nav aria-label="breadcrumb">
                        <ol class="breadcrumb">
                            <li class="breadcrumb-item"><a href="{% url 'dashboard' %}">Home</a></li>
                            <li class="breadcrumb-item"><a href="{% url 'ticket_list' %}">Tickets</a></li>
                            <li class="breadcrumb-item active" aria-current="page">Customer: {{ customer.firstName }} {% if customer.lastName %}{{ customer.lastName }}{% endif %} ({{ customer.email }})</li>
                        </ol>
                    </nav>
                    <a href="{% url 'ticket_list' %}" class="btn btn-secondary">Clear Filter</a>
                </div>
                {% endif %}
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Ticket List</h3>
                        <div class="card-tools">
                            <a href="{% url 'ticket_create' %}" class="btn btn-primary btn-sm">Create Ticket</a>
                        </div>
                    </div>
                    <div class="card-body" style="overflow-x: auto;">
                        {% if tickets %}
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>Subject</th>
                                    <th>Customer</th>
                                    <th>Status</th>
                                    <th>Priority</th>
                                    <th>Assigned To</th>
                                    <th>Created At</th>
                                </tr>
                            </thead>
                            <tbody id="ticket-table-body">
                                {% for ticket in tickets.object_list %}
                                <tr>
                                    <td><a href="{% url 'ticket_view' ticket.id %}">{{ ticket.subject }}</a></td>
                                    <td>{{ ticket.customer.user.email }}</td>
                                    <td>{{ ticket.status.description }}</td>
                                    <td>{{ ticket.priority.description }}</td>
                                    <td>{% if ticket.agent %}{{ ticket.agent.user.email }}{% else %}Unassigned{% endif %}</td>
                                    <td>{{ ticket.createdAt|date:"M d, Y H:i" }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                        <nav aria-label="Page navigation example">
                            <ul class="pagination justify-content-center">
                                {% if tickets.has_previous %}
                                    <li class="page-item"><a class="page-link" href="?page={{ tickets.previous_page_number }}">Previous</a></li>
                                {% else %}
                                    <li class="page-item disabled"><a class="page-link" href="#">Previous</a></li>
                                {% endif %}

                                {% for i in tickets.paginator.page_range %}
                                    {% if tickets.number == i %}
                                        <li class="page-item active"><a class="page-link" href="#">{{ i }}</a></li>
                                    {% else %}
                                        <li class="page-item"><a class="page-link" href="?page={{ i }}">{{ i }}</a></li>
                                    {% endif %}
                                {% endfor %}

                                {% if tickets.has_next %}
                                    <li class="page-item"><a class="page-link" href="?page={{ tickets.next_page_number }}">Next</a></li>
                                {% else %}
                                    <li class="page-item disabled"><a class="page-link" href="#">Next</a></li>
                                {% endif %}
                            </ul>
                        </nav>
                        {% else %}
                        <p>No tickets found.</p>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
      </div><!-- /.container-fluid -->
    </section>
    <!-- /.content -->

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const sidebarFilters = document.querySelectorAll('.sidebar-filter');
        const statusSubfiltersCard = document.getElementById('status-subfilters');
        const labelSubfiltersCard = document.getElementById('label-subfilters');
        const ticketTableBody = document.querySelector('#ticket-table-body');
        const sidebarFilterBadges = document.querySelectorAll('.sidebar-filter');
        const statusSubfilterBadges = document.querySelectorAll('.status-subfilter');

        let currentPrimaryFilter = 'all'; // Default to 'all'
        let currentStatusCode = null; // Track current status code
        let currentLabelId = null; // Track current label ID
        let currentPage = 1; // Track current page

        function updateTicketList(primaryFilter, statusCode = null, labelId = null, page = 1) {
            let url = '{% url "get_filtered_tickets_and_counts" %}';
            const params = new URLSearchParams();
            params.append('filter_type', primaryFilter);
            if (statusCode) {
                params.append('status_code', statusCode);
            }
            if (labelId) {
                params.append('label_id', labelId);
            }
            params.append('page', page); // Add page parameter
            const customerId = "{{ customer_id }}";
            if (customerId) {
                params.append('customer_id', customerId);
            }
            url += `?${params.toString()}`;

            fetch(url)
                .then(response => response.json())
                .then(data => {
                    // Update ticket table
                    ticketTableBody.innerHTML = '';
                    if (data.tickets.length > 0) {
                        data.tickets.forEach(ticket => {
                            const row = `
                                <tr>
                                    <td><a href="/member/tickets/${ticket.id}/">${ticket.subject}</a></td>
                                    <td>${ticket.customer_email}</td>
                                    <td>${ticket.status_description}</td>
                                    <td>${ticket.priority_description}</td>
                                    <td>${ticket.agent_email}</td>
                                    <td>${ticket.created_at}</td>
                                </tr>
                            `;
                            ticketTableBody.insertAdjacentHTML('beforeend', row);
                        });
                    } else {
                        ticketTableBody.innerHTML = '<tr><td colspan="6" class="text-center">No tickets found.</td></tr>';
                    }

                    // Update sidebar filter counts
                    for (const key in data.sidebar_filters) {
                        const filterElement = document.querySelector(`.sidebar-filter[data-filter-type="${key}"]`);
                        if (filterElement) {
                            filterElement.nextElementSibling.textContent = data.sidebar_filters[key].count;
                        }
                    }

                    // Update status sub-filter counts
                    for (const code in data.status_counts) {
                        const subfilterElement = document.querySelector(`.status-subfilter[data-status-code="${code}"]`);
                        if (subfilterElement) {
                            subfilterElement.nextElementSibling.textContent = data.status_counts[code].count;
                        }
                    }

                    // Update label sub-filter counts
                    for (const id in data.label_counts) {
                        const subfilterElement = document.querySelector(`.label-subfilter[data-label-id="${id}"]`);
                        if (subfilterElement) {
                            subfilterElement.nextElementSibling.textContent = data.label_counts[id].count;
                        }
                    }

                    // Update pagination controls
                    const paginationNav = document.querySelector('.pagination');
                    paginationNav.innerHTML = ''; // Clear existing pagination

                    const baseUrl = `?filter_type=${primaryFilter}`;
                    const statusParam = statusCode ? `&status_code=${statusCode}` : '';
                    const labelParam = labelId ? `&label_id=${labelId}` : '';
                    const customerParam = customerId ? `&customer_id=${customerId}` : '';

                    if (data.pagination.has_previous) {
                        paginationNav.insertAdjacentHTML('beforeend', `<li class="page-item"><a class="page-link" href="${baseUrl}${statusParam}${labelParam}${customerParam}&page=${data.pagination.previous_page_number}">Previous</a></li>`);
                    } else {
                        paginationNav.insertAdjacentHTML('beforeend', `<li class="page-item disabled"><a class="page-link" href="#">Previous</a></li>`);
                    }

                    data.pagination.page_range.forEach(pageNum => {
                        if (pageNum === data.pagination.current_page) {
                            paginationNav.insertAdjacentHTML('beforeend', `<li class="page-item active"><a class="page-link" href="#">${pageNum}</a></li>`);
                        } else {
                            paginationNav.insertAdjacentHTML('beforeend', `<li class="page-item"><a class="page-link" href="${baseUrl}${statusParam}${labelParam}${customerParam}&page=${pageNum}">${pageNum}</a></li>`);
                        }
                    });

                    if (data.pagination.has_next) {
                        paginationNav.insertAdjacentHTML('beforeend', `<li class="page-item"><a class="page-link" href="${baseUrl}${statusParam}${labelParam}${customerParam}&page=${data.pagination.next_page_number}">Next</a></li>`);
                    } else {
                        paginationNav.insertAdjacentHTML('beforeend', `<li class="page-item disabled"><a class="page-link" href="#">Next</a></li>`);
                    }

                    // Add event listeners to new pagination links
                    paginationNav.querySelectorAll('.page-link').forEach(link => {
                        if (!link.parentElement.classList.contains('disabled') && !link.parentElement.classList.contains('active')) {
                            link.addEventListener('click', function(e) {
                                e.preventDefault();
                                const newPage = parseInt(this.dataset.page);
                                updateTicketList(currentPrimaryFilter, currentStatusCode, currentLabelId, newPage); // Pass all current filters and new page
                            });
                        }
                    });

                    currentPage = data.pagination.current_page; // Update current page tracker
                })
                .catch(error => console.error('Error fetching tickets:', error));
        }

        sidebarFilters.forEach(filter => {
            filter.addEventListener('click', function(e) {
                e.preventDefault();
                // Show all sub-filters when any primary filter is clicked
                statusSubfiltersCard.style.display = 'block';
                labelSubfiltersCard.style.display = 'block';

                const filterType = this.dataset.filterType;
                currentPrimaryFilter = filterType; // Update current primary filter
                currentStatusCode = null; // Reset status filter when primary filter changes
                currentLabelId = null; // Reset label filter when primary filter changes
                updateTicketList(currentPrimaryFilter, currentStatusCode, currentLabelId); // Fetch tickets for the selected primary filter, reset sub-filters and to page 1

                // Remove active class from all sidebar filters
                sidebarFilters.forEach(f => f.classList.remove('active'));
                // Add active class to the clicked filter
                this.classList.add('active');

                // Remove active class from all status sub-filters
                statusSubfilters.forEach(sf => sf.classList.remove('active'));
                // Remove active class from all label sub-filters
                labelSubfilters.forEach(lf => lf.classList.remove('active'));
            });
        });

        const statusSubfilters = document.querySelectorAll('.status-subfilter');
        statusSubfilters.forEach(subfilter => {
            subfilter.addEventListener('click', function(e) {
                e.preventDefault();
                const statusCode = this.dataset.statusCode;
                currentStatusCode = statusCode; // Update current status code
                currentLabelId = null; // Reset label filter when status filter changes
                updateTicketList(currentPrimaryFilter, currentStatusCode, currentLabelId); // Fetch tickets for current primary and selected status, reset label filter and to page 1

                // Remove active class from all status sub-filters
                statusSubfilters.forEach(sf => sf.classList.remove('active'));
                // Add active class to the clicked sub-filter
                this.classList.add('active');

                // Remove active class from all label sub-filters
                labelSubfilters.forEach(lf => lf.classList.remove('active'));
            });
        });

        const labelSubfilters = document.querySelectorAll('.label-subfilter');
        labelSubfilters.forEach(subfilter => {
            subfilter.addEventListener('click', function(e) {
                e.preventDefault();
                const labelId = this.dataset.labelId;
                currentLabelId = labelId; // Update current label ID
                currentStatusCode = null; // Reset status filter when label filter changes
                updateTicketList(currentPrimaryFilter, currentStatusCode, currentLabelId); // Fetch tickets for current primary and selected label, reset status filter and to page 1

                // Remove active class from all label sub-filters
                labelSubfilters.forEach(lf => lf.classList.remove('active'));
                // Add active class to the clicked sub-filter
                this.classList.add('active');

                // Remove active class from all status sub-filters
                statusSubfilters.forEach(sf => sf.classList.remove('active'));
            });
        });

        // Initial load
        updateTicketList(currentPrimaryFilter, currentStatusCode, currentLabelId, currentPage);
    });
</script>
{% endblock %}
